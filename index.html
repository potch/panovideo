
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      * {
        margin: 0;
      }
      #video {
        position: absolute;
        top: 0;
        left: 0;
        width: 21vw;
        height: 3vw;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <video id="video" src="test1.mp4" crossorigin="anonymous" height="4096" width="571"></video>
    <script src="three.min.js"></script>
    <script src="node_modules/three-vreffect/VREffect.js"></script>
    <script src="node_modules/three-vrcontrols/VRControls.js"></script>
    <script>
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
      var renderer = new THREE.WebGLRenderer();
      self.renderer.setClearColor( 0x000000 );
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      camera.lookAt({x:0,y:0,z:0});

      var video = document.querySelector('#video');
      console.log(video);
      video.play();

      videoTexture = new THREE.Texture( video );
      videoTexture.minFilter = THREE.LinearFilter;
      videoTexture.magFilter = THREE.LinearFilter;
      videoTexture.flipY = true;

      var movieMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: true, side:THREE.DoubleSide } );

      var theater = new THREE.Object3D();

      var geometry = new THREE.PlaneGeometry( 2.39, 1, 1 );
      var center = new THREE.Mesh( geometry, movieMaterial );
      center.position.z = -2;
      theater.add(center);
      centerUV = geometry.faceVertexUvs[0];
      for (var i=0; i<centerUV.length; i++) {
        var uvs = centerUV[i];
        for (var j = 0; j < uvs.length; j++) {
          uvs[j].x = uvs[j].x / 3 + (1/3);
        }
      }

      var geometry = new THREE.PlaneGeometry( 2.39, 1, 1 );
      var left = new THREE.Mesh( geometry, movieMaterial );
      left.rotation.y = 70 * Math.PI / 180;
      left.position.z = -.85;
      left.position.x = -1.65;
      theater.add(left);
      leftUV = geometry.faceVertexUvs[0];
      for (var i=0; i<leftUV.length; i++) {
        var uvs = leftUV[i];
        for (var j = 0; j < uvs.length; j++) {
          uvs[j].x = uvs[j].x / 3;
        }
      }

      var geometry = new THREE.PlaneGeometry( 2.39, 1, 1 );
      var right = new THREE.Mesh( geometry, movieMaterial );
      right.rotation.y = -70 * Math.PI / 180;
      right.position.z = -.85;
      right.position.x = 1.65;
      theater.add(right);
      rightUV = geometry.faceVertexUvs[0];
      for (var i=0; i<rightUV.length; i++) {
        var uvs = rightUV[i];
        for (var j = 0; j < uvs.length; j++) {
          uvs[j].x = uvs[j].x / 3 + (2/3);
        }
      }

      scene.add(theater);

      var rx = 0, ry=0;
      var sx = 0, sy = 0;
      var srx, sry;
      var dragging = false;
      window.addEventListener('mousedown', function (e) {
        sx = e.pageX;
        sy = e.pageY;
        srx = rx;
        sry = ry;
        dragging = true;
      });
      window.addEventListener('mousemove', function (e) {
        if (dragging) {
          rx = srx + (sx - e.pageX) / 100;
          ry = sry + (sy - e.pageY) / 100;
          console.log(rx, ry);
        }
      });
      window.addEventListener('mouseup', stopDrag);
      window.addEventListener('mouseleave', stopDrag);
      function stopDrag() {
        dragging = false;
      }
      function frame() {
        if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
          if ( videoTexture ) {
            videoTexture.needsUpdate = true;
          }
        }
        theater.rotation.y = rx;
        theater.rotation.x = ry;
        renderer.render( scene, camera );
        requestAnimationFrame(frame);
      }
      frame();
    </script>
  </body>
</html>
